<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Spring Boot WebSocket Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 30px;
      }
      #chat {
        border: 1px solid #ccc;
        height: 300px;
        overflow-y: scroll;
        padding: 10px;
        margin-bottom: 10px;
      }
      input,
      button {
        padding: 8px;
      }
      #status {
        color: green;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h2>üí¨ Spring Boot WebSocket Chat Demo</h2>
    <div>
      <label>Username: </label>
      <input type="text" id="username" placeholder="vd: alice" />
      <button onclick="login()">Login</button>
    </div>

    <div id="tokenDiv" style="margin-top: 10px; display: none">
      <p>JWT Token: <span id="token" style="color: blue"></span></p>
      <p id="status"></p>
    </div>

    <div id="chatArea" style="display: none">
      <div>
        <label>Send to: </label>
        <input type="text" id="recipient" placeholder="vd: bob" />
      </div>

      <div id="chat"></div>

      <input type="text" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." />
      <button onclick="sendMessage()">G·ª≠i</button>
    </div>

    <script>
      let stompClient = null;
      let token = "";
      let username = "";

      function login() {
        username = document.getElementById("username").value.trim();
        if (!username) {
          alert("Nh·∫≠p username tr∆∞·ªõc!");
          return;
        }
        fetch("/login?username=" + username)
          .then((res) => res.text())
          .then((t) => {
            token = t;
            document.getElementById("token").textContent = token;
            document.getElementById("tokenDiv").style.display = "block";
            connect();
          })
          .catch((err) => alert("Login failed: " + err));
      }

      function connect() {
        const socket = new SockJS("/ws");
        stompClient = Stomp.over(socket);

        stompClient.connect(
          { Authorization: "Bearer " + token },
          (frame) => {
            document.getElementById("status").innerText =
              "ƒê√£ k·∫øt n·ªëi WebSocket ‚úÖ";
            document.getElementById("chatArea").style.display = "block";
            document.getElementById("chat").innerHTML +=
              "<p><em>B·∫°n ƒë√£ ƒëƒÉng nh·∫≠p l√† <b>" + username + "</b></em></p>";
            stompClient.subscribe("/user/queue/messages", (msg) => {
              const data = JSON.parse(msg.body);
              appendMessage(data.sender + ": " + data.content);
            });
            stompClient.subscribe("/topic/online", (msg) => {
              const list = JSON.parse(msg.body);
              appendMessage("<em>Online: " + list.join(", ") + "</em>");
            });
          },
          (err) => {
            document.getElementById("status").innerText = "L·ªói k·∫øt n·ªëi ‚ùå";
            console.error(err);
          }
        );
      }
      function sendMessage() {
        const recipient = document.getElementById("recipient").value.trim();
        const content = document.getElementById("messageInput").value.trim();
        if (!recipient || !content) return;
        const msg = {
          sender: username,
          recipient: recipient,
          content: content,
          type: "CHAT",
        };
        stompClient.send("/app/chat.private", {}, JSON.stringify(msg));
        appendMessage("B·∫°n: " + content);
        document.getElementById("messageInput").value = "";
      }
      function appendMessage(text) {
        const chat = document.getElementById("chat");
        chat.innerHTML += "<div>" + text + "</div>";
        chat.scrollTop = chat.scrollHeight;
      }
    </script>
  </body>
</html>
